syntax = "proto3";

package echo.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

import "echo/v1/common.proto";
import "echo/v1/finance.proto";

service InsightsService {
  rpc GetMonthlyInsights(GetMonthlyInsightsRequest) returns (GetMonthlyInsightsResponse);
  rpc GetWrapped(GetWrappedRequest) returns (GetWrappedResponse);

  // Spending Pulse - "What changed?" comparative insights
  rpc GetSpendingPulse(GetSpendingPulseRequest) returns (GetSpendingPulseResponse);
  rpc GetDashboardBlocks(GetDashboardBlocksRequest) returns (GetDashboardBlocksResponse);

  // Alert management
  rpc ListAlerts(ListAlertsRequest) returns (ListAlertsResponse);
  rpc MarkAlertRead(MarkAlertReadRequest) returns (MarkAlertReadResponse);
  rpc DismissAlert(DismissAlertRequest) returns (DismissAlertResponse);

  // Import quality insights - bridge between Import and Insights services
  rpc GetImportInsights(GetImportInsightsRequest) returns (GetImportInsightsResponse);
  rpc GetDataSourceHealth(GetDataSourceHealthRequest) returns (GetDataSourceHealthResponse);
}

message CategorySpend {
  string category_id = 1 [(buf.validate.field).string = { uuid: true }];
  Money total = 2 [(buf.validate.field).required = true];
}

message MerchantSpend {
  string merchant_name = 1 [(buf.validate.field).string = { min_len: 1 max_len: 255 }];
  Money total = 2 [(buf.validate.field).required = true];
}

message MonthlyInsights {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];

  google.protobuf.Timestamp month_start = 3 [(buf.validate.field).required = true];
  Money total_spend = 4 [(buf.validate.field).required = true];
  Money total_income = 5 [(buf.validate.field).required = true];
  Money net = 6 [(buf.validate.field).required = true];

  repeated CategorySpend top_categories = 10 [(buf.validate.field).repeated = { max_items: 50 }];
  repeated MerchantSpend top_merchants = 11 [(buf.validate.field).repeated = { max_items: 50 }];

  // Human-readable, privacy-safe bullet insights.
  repeated string highlights = 20 [(buf.validate.field).repeated = {
    max_items: 20
    items: { string: { min_len: 1 max_len: 240 } }
  }];

  google.protobuf.Timestamp created_at = 30 [(buf.validate.field).required = true];
}

message GetMonthlyInsightsRequest {
  google.protobuf.Timestamp month_start = 1 [(buf.validate.field).required = true];
}

message GetMonthlyInsightsResponse {
  MonthlyInsights insights = 1 [(buf.validate.field).required = true];
}

enum WrappedPeriod {
  WRAPPED_PERIOD_UNSPECIFIED = 0;
  WRAPPED_PERIOD_MONTH = 1;
  WRAPPED_PERIOD_YEAR = 2;
}

message WrappedCard {
  string title = 1 [(buf.validate.field).string = { min_len: 1 max_len: 64 }];
  string subtitle = 2 [(buf.validate.field).string = { max_len: 128 }];
  string body = 3 [(buf.validate.field).string = { max_len: 512 }];
  string accent = 4 [(buf.validate.field).string = { max_len: 32 }];
}

message WrappedSummary {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  WrappedPeriod period = 3 [(buf.validate.field).enum = { defined_only: true }];
  google.protobuf.Timestamp period_start = 4 [(buf.validate.field).required = true];
  google.protobuf.Timestamp period_end = 5 [(buf.validate.field).required = true];
  repeated WrappedCard cards = 10 [(buf.validate.field).repeated = { max_items: 200 }];
  google.protobuf.Timestamp created_at = 20 [(buf.validate.field).required = true];
}

message GetWrappedRequest {
  WrappedPeriod period = 1 [(buf.validate.field).enum = { defined_only: true not_in: [0] }];
  google.protobuf.Timestamp period_start = 2 [(buf.validate.field).required = true];
  google.protobuf.Timestamp period_end = 3 [(buf.validate.field).required = true];
}

message GetWrappedResponse {
  WrappedSummary wrapped = 1 [(buf.validate.field).required = true];
}

// Spending Pulse messages
message GetSpendingPulseRequest {
  optional google.protobuf.Timestamp as_of = 1; // Default: now
}

message SpendingPulse {
  Money current_month_spend = 1;
  Money last_month_spend = 2;
  Money spend_delta = 3; // current - last
  double pace_percent = 4; // 100 = on track, >100 = ahead
  bool is_over_pace = 5;
  string pace_message = 6; // "Spending ahead", "Under budget", etc.

  int32 day_of_month = 10;
  int32 transaction_count = 11;
  google.protobuf.Timestamp as_of_date = 12;

  repeated TopCategorySpend top_categories = 20;
  repeated SurpriseExpense surprise_expenses = 21;
}

message TopCategorySpend {
  optional string category_id = 1 [(buf.validate.field).string = { uuid: true }];
  string category_name = 2;
  Money amount = 3;
  int32 transaction_count = 4;
}

message SurpriseExpense {
  string transaction_id = 1 [(buf.validate.field).string = { uuid: true }];
  string description = 2;
  string merchant_name = 3;
  Money amount = 4;
  google.protobuf.Timestamp posted_at = 5;
  optional string category_name = 6;
}

message GetSpendingPulseResponse {
  SpendingPulse pulse = 1;
  bool should_notify = 2; // True if pace notification should fire
}

// Dashboard Blocks (Bento Grid)
message GetDashboardBlocksRequest {}

message DashboardBlock {
  string type = 1; // "status", "hook", "cta"
  string title = 2;
  string subtitle = 3;
  string value = 4;
  string icon = 5;
  string color = 6;
  optional string action = 7;
}

message GetDashboardBlocksResponse {
  repeated DashboardBlock blocks = 1 [(buf.validate.field).repeated = { max_items: 10 }];
}

// Alert severity levels
enum AlertSeverity {
  ALERT_SEVERITY_UNSPECIFIED = 0;
  ALERT_SEVERITY_INFO = 1;
  ALERT_SEVERITY_WARNING = 2;
  ALERT_SEVERITY_CRITICAL = 3;
}

// Alert types
enum AlertType {
  ALERT_TYPE_UNSPECIFIED = 0;
  ALERT_TYPE_PACE_WARNING = 1;
  ALERT_TYPE_SURPRISE_EXPENSE = 2;
  ALERT_TYPE_GOAL_PROGRESS = 3;
  ALERT_TYPE_SUBSCRIPTION_DUE = 4;
}

// Alert message
message Alert {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  AlertType alert_type = 3;
  AlertSeverity severity = 4;
  string title = 5;
  string message = 6;
  bool is_read = 7;
  bool is_dismissed = 8;
  google.protobuf.Timestamp alert_date = 9;
  google.protobuf.Timestamp created_at = 10;
}

// List alerts for user
message ListAlertsRequest {
  bool unread_only = 1; // Filter to unread only
  int32 limit = 2 [(buf.validate.field).int32 = { gte: 1, lte: 50 }];
}

message ListAlertsResponse {
  repeated Alert alerts = 1;
}

// Mark alert as read
message MarkAlertReadRequest {
  string alert_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message MarkAlertReadResponse {}

// Dismiss alert
message DismissAlertRequest {
  string alert_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message DismissAlertResponse {}

// ============================================================================
// Import Quality Insights
// ============================================================================

// Get insights about a specific import job
message GetImportInsightsRequest {
  string import_job_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message GetImportInsightsResponse {
  ImportInsights insights = 1;
}

// Quality metrics and issues for an import job
message ImportInsights {
  string import_job_id = 1 [(buf.validate.field).string = { uuid: true }];
  string institution_name = 2 [(buf.validate.field).string = { max_len: 128 }];
  
  // Row counts
  int32 total_rows = 3 [(buf.validate.field).int32 = { gte: 0 }];
  int32 rows_imported = 4 [(buf.validate.field).int32 = { gte: 0 }];
  int32 rows_failed = 5 [(buf.validate.field).int32 = { gte: 0 }];
  int32 duplicates_skipped = 6 [(buf.validate.field).int32 = { gte: 0 }];
  
  // Quality metrics (0.0 - 1.0)
  double categorization_rate = 10;
  double date_quality_score = 11;
  double amount_quality_score = 12;
  
  // Date range of imported data
  google.protobuf.Timestamp earliest_date = 15;
  google.protobuf.Timestamp latest_date = 16;
  
  // Money totals
  Money total_income = 20;
  Money total_expenses = 21;
  
  // Detected issues
  repeated ImportIssue issues = 25 [(buf.validate.field).repeated = { max_items: 50 }];
}

// Issue detected during import
message ImportIssue {
  ImportIssueType type = 1 [(buf.validate.field).enum = { defined_only: true }];
  int32 affected_rows = 2 [(buf.validate.field).int32 = { gte: 0 }];
  string sample_value = 3 [(buf.validate.field).string = { max_len: 255 }];
  string suggestion = 4 [(buf.validate.field).string = { max_len: 512 }];
}

// Types of import issues
enum ImportIssueType {
  IMPORT_ISSUE_TYPE_UNSPECIFIED = 0;
  IMPORT_ISSUE_TYPE_UNPARSEABLE_DATE = 1;
  IMPORT_ISSUE_TYPE_INVALID_AMOUNT = 2;
  IMPORT_ISSUE_TYPE_MISSING_DESCRIPTION = 3;
  IMPORT_ISSUE_TYPE_DUPLICATE_ROWS = 4;
  IMPORT_ISSUE_TYPE_UNCATEGORIZED = 5;
  IMPORT_ISSUE_TYPE_FUTURE_DATE = 6;
}

// ============================================================================
// Data Source Health
// ============================================================================

// Get health metrics for all connected data sources
message GetDataSourceHealthRequest {}

message GetDataSourceHealthResponse {
  repeated DataSourceHealth sources = 1 [(buf.validate.field).repeated = { max_items: 100 }];
  int32 total_transaction_count = 2 [(buf.validate.field).int32 = { gte: 0 }];
  google.protobuf.Timestamp oldest_transaction = 3;
}

// Health metrics for a single data source
message DataSourceHealth {
  string institution_name = 1 [(buf.validate.field).string = { max_len: 128 }];
  TransactionSource source_type = 2 [(buf.validate.field).enum = { defined_only: true }];
  
  // Transaction metrics
  int32 transaction_count = 3 [(buf.validate.field).int32 = { gte: 0 }];
  google.protobuf.Timestamp first_transaction = 4;
  google.protobuf.Timestamp last_transaction = 5;
  google.protobuf.Timestamp last_import = 6;
  
  // Quality metrics
  double categorization_rate = 10;
  int32 uncategorized_count = 11 [(buf.validate.field).int32 = { gte: 0 }];
  
  // Coverage gaps (date ranges with no data)
  repeated DateGap gaps = 15 [(buf.validate.field).repeated = { max_items: 50 }];
}

// A gap in transaction data coverage
message DateGap {
  google.protobuf.Timestamp start = 1 [(buf.validate.field).required = true];
  google.protobuf.Timestamp end = 2 [(buf.validate.field).required = true];
  int32 gap_days = 3 [(buf.validate.field).int32 = { gte: 1 }];
}
