syntax = "proto3";

package echo.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

import "echo/v1/common.proto";

option go_package = "buf.build/gen/go/echo-tracker/echo/protocolbuffers/go/echo/v1;echov1";

service FinanceService {
  rpc CreateAccount(CreateAccountRequest) returns (CreateAccountResponse);
  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse);

  rpc CreateCategory(CreateCategoryRequest) returns (CreateCategoryResponse);
  rpc ListCategories(ListCategoriesRequest) returns (ListCategoriesResponse);

  rpc ImportTransactionsCsv(ImportTransactionsCsvRequest) returns (ImportTransactionsCsvResponse);
  rpc ListTransactions(ListTransactionsRequest) returns (ListTransactionsResponse);
  rpc DeleteImportBatch(DeleteImportBatchRequest) returns (DeleteImportBatchResponse);

  // Quick Capture: Create a transaction from natural language input
  rpc CreateManualTransaction(CreateManualTransactionRequest) returns (CreateManualTransactionResponse);

  // Goals management
  rpc CreateGoal(CreateGoalRequest) returns (CreateGoalResponse);
  rpc GetGoal(GetGoalRequest) returns (GetGoalResponse);
  rpc UpdateGoal(UpdateGoalRequest) returns (UpdateGoalResponse);
  rpc DeleteGoal(DeleteGoalRequest) returns (DeleteGoalResponse);
  rpc ListGoals(ListGoalsRequest) returns (ListGoalsResponse);
  rpc GetGoalProgress(GetGoalProgressRequest) returns (GetGoalProgressResponse);
  rpc ContributeToGoal(ContributeToGoalRequest) returns (ContributeToGoalResponse);

  // Recurring subscriptions management
  rpc ListRecurringSubscriptions(ListRecurringSubscriptionsRequest) returns (ListRecurringSubscriptionsResponse);
  rpc DetectRecurringSubscriptions(DetectRecurringSubscriptionsRequest) returns (DetectRecurringSubscriptionsResponse);
  rpc UpdateSubscriptionStatus(UpdateSubscriptionStatusRequest) returns (UpdateSubscriptionStatusResponse);
  rpc GetSubscriptionReviewChecklist(GetSubscriptionReviewChecklistRequest) returns (GetSubscriptionReviewChecklistResponse);

  // Categorization rules for "Remember this" learning
  rpc CreateCategoryRule(CreateCategoryRuleRequest) returns (CreateCategoryRuleResponse);
  rpc ListCategoryRules(ListCategoryRulesRequest) returns (ListCategoryRulesResponse);
}

enum AccountType {
  ACCOUNT_TYPE_UNSPECIFIED = 0;
  ACCOUNT_TYPE_CASH = 1;
  ACCOUNT_TYPE_CHECKING = 2;
  ACCOUNT_TYPE_SAVINGS = 3;
  ACCOUNT_TYPE_CREDIT_CARD = 4;
  ACCOUNT_TYPE_INVESTMENT = 5;
  ACCOUNT_TYPE_LOAN = 6;
  ACCOUNT_TYPE_OTHER = 7;
}

message Account {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  string name = 3 [(buf.validate.field).string = { min_len: 1 max_len: 120 }];
  AccountType type = 4 [(buf.validate.field).enum = { defined_only: true }];
  string currency_code = 5 [(buf.validate.field).string = { pattern: "^[A-Z]{3}$" }];

  string institution = 10 [(buf.validate.field).string = { max_len: 120 }];
  optional string last4 = 11 [(buf.validate.field).string = {
    pattern: "^[0-9]{4}$"
  }];
  bool is_active = 12;

  google.protobuf.Timestamp created_at = 20 [(buf.validate.field).required = true];
  google.protobuf.Timestamp updated_at = 21 [(buf.validate.field).required = true];
}

message CreateAccountRequest {
  string name = 1 [(buf.validate.field).string = { min_len: 1 max_len: 120 }];
  AccountType type = 2 [(buf.validate.field).enum = { defined_only: true not_in: [0] }];
  string currency_code = 3 [(buf.validate.field).string = { pattern: "^[A-Z]{3}$" }];
  string institution = 4 [(buf.validate.field).string = { max_len: 120 }];
  optional string last4 = 5 [(buf.validate.field).string = {
    pattern: "^[0-9]{4}$"
  }];
}

message CreateAccountResponse {
  Account account = 1 [(buf.validate.field).required = true];
}

message ListAccountsRequest {}

message ListAccountsResponse {
  repeated Account accounts = 1 [(buf.validate.field).repeated = { max_items: 1000 }];
}

message Category {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  string name = 3 [(buf.validate.field).string = { min_len: 1 max_len: 80 }];
  optional string parent_id = 4 [(buf.validate.field).string = { uuid: true }];
  string color = 10 [(buf.validate.field).string = { max_len: 32 }];
  string icon = 11 [(buf.validate.field).string = { max_len: 64 }];
  google.protobuf.Timestamp created_at = 20 [(buf.validate.field).required = true];
  google.protobuf.Timestamp updated_at = 21 [(buf.validate.field).required = true];
}

message CreateCategoryRequest {
  string name = 1 [(buf.validate.field).string = { min_len: 1 max_len: 80 }];
  optional string parent_id = 2 [(buf.validate.field).string = { uuid: true }];
  string color = 3 [(buf.validate.field).string = { max_len: 32 }];
  string icon = 4 [(buf.validate.field).string = { max_len: 64 }];
}

message CreateCategoryResponse {
  Category category = 1 [(buf.validate.field).required = true];
}

message ListCategoriesRequest {}

message ListCategoriesResponse {
  repeated Category categories = 1 [(buf.validate.field).repeated = { max_items: 5000 }];
}

enum TransactionSource {
  TRANSACTION_SOURCE_UNSPECIFIED = 0;
  TRANSACTION_SOURCE_MANUAL = 1;
  TRANSACTION_SOURCE_CSV = 2;
  TRANSACTION_SOURCE_AGGREGATOR = 3;
}

message Transaction {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  optional string account_id = 3 [(buf.validate.field).string = { uuid: true }];
  optional string category_id = 4 [(buf.validate.field).string = { uuid: true }];

  google.protobuf.Timestamp posted_at = 10 [(buf.validate.field).required = true];
  string description = 11 [(buf.validate.field).string = { min_len: 1 max_len: 512 }];
  string merchant_name = 12 [(buf.validate.field).string = { max_len: 255 }];
  string original_description = 13 [(buf.validate.field).string = { max_len: 512 }];

  Money amount = 20 [(buf.validate.field).required = true];
  TransactionSource source = 21 [(buf.validate.field).enum = { defined_only: true }];
  string external_id = 22 [(buf.validate.field).string = { max_len: 255 }];
  string notes = 23 [(buf.validate.field).string = { max_len: 2048 }];
  string institution_name = 24 [(buf.validate.field).string = { max_len: 128 }];

  google.protobuf.Timestamp created_at = 30 [(buf.validate.field).required = true];
  google.protobuf.Timestamp updated_at = 31 [(buf.validate.field).required = true];
}

message CsvMapping {
  string date_column = 1;
  string description_column = 2;
  string amount_column = 3;
  string debit_column = 4;
  string credit_column = 5;
  // True for European number format (comma as decimal: 1.234,56)
  bool is_european_format = 6;
  // Detected delimiter from AnalyzeCsvFile (e.g., ";", ",", "\t")
  string delimiter = 7;
  // Number of lines to skip before header row
  int32 skip_lines = 8;
}

message ImportTransactionsCsvRequest {
  // If omitted, the server may create/use a default import account.
  optional string account_id = 1 [(buf.validate.field).string = { uuid: true }];

  // Raw CSV content. For large files, prefer a pre-signed upload in a future version.
  bytes csv_bytes = 2 [(buf.validate.field).bytes = { min_len: 1 max_len: 20000000 }];

  // Optional: a client hint, like "MM/DD/YYYY".
  string date_format = 3 [(buf.validate.field).string = { max_len: 32 }];
  string timezone = 4 [(buf.validate.field).string = { max_len: 64 }];

  CsvMapping mapping = 5;
  int32 header_rows = 6;

  // Name of the bank/institution this import comes from (e.g., "Revolut", "CGD")
  string institution_name = 7 [(buf.validate.field).string = { max_len: 128 }];
}

message ImportTransactionsCsvResponse {
  int32 imported_count = 1 [(buf.validate.field).int32 = { gte: 0 lte: 2000000 }];
  // Number of duplicates that were skipped
  int32 duplicate_count = 2 [(buf.validate.field).int32 = { gte: 0 lte: 2000000 }];
  // ID of the import job (for staging view filtering)
  string import_job_id = 3 [(buf.validate.field).string = { uuid: true }];
}

message ListTransactionsRequest {
  PageRequest page = 1;
  TimeRange time_range = 2;
  optional string account_id = 3 [(buf.validate.field).string = { uuid: true }];
  optional string category_id = 4 [(buf.validate.field).string = { uuid: true }];
  // Filter by import batch (for staging view)
  optional string import_job_id = 5 [(buf.validate.field).string = { uuid: true }];
}

message ListTransactionsResponse {
  repeated Transaction transactions = 1 [(buf.validate.field).repeated = { max_items: 2000 }];
  PageResponse page = 2 [(buf.validate.field).required = true];
}

message DeleteImportBatchRequest {
  string import_job_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message DeleteImportBatchResponse {
  int32 deleted_count = 1 [(buf.validate.field).int32 = { gte: 0 }];
}

enum GoalType {
  GOAL_TYPE_UNSPECIFIED = 0;
  GOAL_TYPE_SAVE = 1;
  GOAL_TYPE_PAY_DOWN_DEBT = 2;
  GOAL_TYPE_SPEND_CAP = 3;
}

enum GoalStatus {
  GOAL_STATUS_UNSPECIFIED = 0;
  GOAL_STATUS_ACTIVE = 1;
  GOAL_STATUS_PAUSED = 2;
  GOAL_STATUS_COMPLETED = 3;
  GOAL_STATUS_ARCHIVED = 4;
}

message Goal {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  string name = 3 [(buf.validate.field).string = { min_len: 1 max_len: 120 }];
  GoalType type = 4 [(buf.validate.field).enum = { defined_only: true }];
  GoalStatus status = 5 [(buf.validate.field).enum = { defined_only: true }];

  Money target = 10 [(buf.validate.field).required = true];
  int64 current_amount_minor = 11 [(buf.validate.field).int64 = {
    gte: -900000000000000
    lte: 900000000000000
  }];

  google.protobuf.Timestamp start_at = 20 [(buf.validate.field).required = true];
  google.protobuf.Timestamp end_at = 21 [(buf.validate.field).required = true];
  google.protobuf.Timestamp created_at = 22 [(buf.validate.field).required = true];
  google.protobuf.Timestamp updated_at = 23 [(buf.validate.field).required = true];

  // Progress fields (computed)
  double progress_percent = 30;  // 0-100, current/target
  double pace_percent = 31;      // 100 = on track, <100 = behind
  bool is_behind_pace = 32;
  string pace_message = 33;      // "On track", "2 weeks behind", etc.
  int32 days_remaining = 34;
  Money amount_needed_per_day = 35;  // To reach goal on time
}

message CreateGoalRequest {
  string name = 1 [(buf.validate.field).string = { min_len: 1 max_len: 120 }];
  GoalType type = 2 [(buf.validate.field).enum = { defined_only: true not_in: [0] }];
  Money target = 3 [(buf.validate.field).required = true];
  google.protobuf.Timestamp start_at = 4 [(buf.validate.field).required = true];
  google.protobuf.Timestamp end_at = 5 [(buf.validate.field).required = true];
}

message CreateGoalResponse {
  Goal goal = 1 [(buf.validate.field).required = true];
}

message ListGoalsRequest {
  optional GoalStatus status_filter = 1;  // Filter by status
}

message ListGoalsResponse {
  repeated Goal goals = 1 [(buf.validate.field).repeated = { max_items: 2000 }];
}

message GetGoalRequest {
  string goal_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message GetGoalResponse {
  Goal goal = 1 [(buf.validate.field).required = true];
}

message UpdateGoalRequest {
  string goal_id = 1 [(buf.validate.field).string = { uuid: true }];
  optional string name = 2 [(buf.validate.field).string = { min_len: 1 max_len: 120 }];
  optional Money target = 3;
  optional google.protobuf.Timestamp end_at = 4;
  optional GoalStatus status = 5;
}

message UpdateGoalResponse {
  Goal goal = 1 [(buf.validate.field).required = true];
}

message DeleteGoalRequest {
  string goal_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message DeleteGoalResponse {}

message GetGoalProgressRequest {
  string goal_id = 1 [(buf.validate.field).string = { uuid: true }];
}

message GetGoalProgressResponse {
  Goal goal = 1 [(buf.validate.field).required = true];

  // Detailed progress breakdown
  repeated GoalMilestone milestones = 2;  // Progress checkpoints
  repeated GoalContribution recent_contributions = 3;  // Recent deposits/progress

  // Nudge information
  bool needs_attention = 10;
  string nudge_message = 11;  // "Add €50 this week to stay on track"
  Money suggested_contribution = 12;  // Recommended next contribution
}

message GoalMilestone {
  int32 percent = 1;  // 25, 50, 75, 100
  bool reached = 2;
  google.protobuf.Timestamp reached_at = 3;
  google.protobuf.Timestamp expected_by = 4;  // Based on timeline
}

message GoalContribution {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  Money amount = 2;
  google.protobuf.Timestamp contributed_at = 3;
  optional string note = 4;
  optional string transaction_id = 5;  // Link to transaction if from import
}

message ContributeToGoalRequest {
  string goal_id = 1 [(buf.validate.field).string = { uuid: true }];
  Money amount = 2 [(buf.validate.field).required = true];
  optional string note = 3 [(buf.validate.field).string = { max_len: 255 }];
}

message ContributeToGoalResponse {
  Goal goal = 1 [(buf.validate.field).required = true];
  GoalContribution contribution = 2;

  // Celebration feedback
  bool milestone_reached = 3;
  optional int32 milestone_percent = 4;  // 25, 50, 75, 100
  string feedback_message = 5;  // "Great job! You're 50% there!"
}

enum RecurringStatus {
  RECURRING_STATUS_UNSPECIFIED = 0;
  RECURRING_STATUS_ACTIVE = 1;
  RECURRING_STATUS_PAUSED = 2;
  RECURRING_STATUS_CANCELED = 3;
}

enum RecurringCadence {
  RECURRING_CADENCE_UNSPECIFIED = 0;
  RECURRING_CADENCE_WEEKLY = 1;
  RECURRING_CADENCE_MONTHLY = 2;
  RECURRING_CADENCE_QUARTERLY = 3;
  RECURRING_CADENCE_ANNUAL = 4;
  RECURRING_CADENCE_UNKNOWN = 5;
}

message RecurringSubscription {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  string merchant_name = 3 [(buf.validate.field).string = { min_len: 1 max_len: 255 }];
  Money amount = 4 [(buf.validate.field).required = true];
  RecurringCadence cadence = 5 [(buf.validate.field).enum = { defined_only: true }];
  RecurringStatus status = 6 [(buf.validate.field).enum = { defined_only: true }];
  google.protobuf.Timestamp first_seen_at = 10;
  google.protobuf.Timestamp last_seen_at = 11;
  google.protobuf.Timestamp next_expected_at = 12;
  google.protobuf.Timestamp created_at = 20 [(buf.validate.field).required = true];
  google.protobuf.Timestamp updated_at = 21 [(buf.validate.field).required = true];

  // Additional computed fields
  int32 occurrence_count = 30;         // Number of times seen
  Money total_spent = 31;               // Total amount spent on this subscription
  optional string category_id = 32;     // Linked category if categorized
  optional string category_name = 33;   // Category name for display
}

message ListRecurringSubscriptionsRequest {
  optional RecurringStatus status_filter = 1;  // Filter by status
  bool include_canceled = 2;  // Include canceled subscriptions
}

message ListRecurringSubscriptionsResponse {
  repeated RecurringSubscription subscriptions = 1 [(buf.validate.field).repeated = { max_items: 5000 }];
  Money total_monthly_cost = 2;  // Sum of all active subscriptions normalized to monthly
  int32 active_count = 3;
}

// Detect recurring patterns in transaction history
message DetectRecurringSubscriptionsRequest {
  // Optional: limit detection to specific time range
  optional google.protobuf.Timestamp since = 1;
  // Minimum occurrences to consider recurring (default: 2)
  optional int32 min_occurrences = 2;
}

message DetectRecurringSubscriptionsResponse {
  repeated RecurringSubscription detected = 1;  // Newly detected subscriptions
  int32 new_count = 2;  // Number of new subscriptions detected
  int32 updated_count = 3;  // Number of existing subscriptions updated
}

// Update subscription status (pause, cancel, reactivate)
message UpdateSubscriptionStatusRequest {
  string subscription_id = 1 [(buf.validate.field).string = { uuid: true }];
  RecurringStatus status = 2 [(buf.validate.field).enum = { defined_only: true not_in: [0] }];
}

message UpdateSubscriptionStatusResponse {
  RecurringSubscription subscription = 1;
}

// Review checklist for subscription management
message GetSubscriptionReviewChecklistRequest {}

message GetSubscriptionReviewChecklistResponse {
  repeated SubscriptionReviewItem items = 1;
  Money potential_monthly_savings = 2;  // If all "review" items are canceled
  string summary = 3;  // "You have 3 subscriptions to review"
}

message SubscriptionReviewItem {
  RecurringSubscription subscription = 1;
  SubscriptionReviewReason reason = 2;
  string reason_message = 3;  // "Not used in 60+ days", "Price increased", etc.
  bool recommended_cancel = 4;
}

enum SubscriptionReviewReason {
  SUBSCRIPTION_REVIEW_REASON_UNSPECIFIED = 0;
  SUBSCRIPTION_REVIEW_REASON_UNUSED = 1;        // No related transactions recently
  SUBSCRIPTION_REVIEW_REASON_PRICE_INCREASE = 2; // Amount increased from previous
  SUBSCRIPTION_REVIEW_REASON_DUPLICATE = 3;      // Similar to another subscription
  SUBSCRIPTION_REVIEW_REASON_HIGH_COST = 4;      // Above average for category
  SUBSCRIPTION_REVIEW_REASON_NEW = 5;            // Recently detected, confirm it's wanted
}

// Category Rules for "Remember this" learning flow
message CategoryRule {
  string id = 1 [(buf.validate.field).string = { uuid: true }];
  string user_id = 2 [(buf.validate.field).string = { uuid: true }];
  string match_pattern = 3 [(buf.validate.field).string = { min_len: 1 max_len: 255 }];
  string clean_name = 4 [(buf.validate.field).string = { max_len: 255 }];
  optional string category_id = 5 [(buf.validate.field).string = { uuid: true }];
  bool is_recurring = 6;
  int32 priority = 7;
  google.protobuf.Timestamp created_at = 20;
  google.protobuf.Timestamp updated_at = 21;
}

message CreateCategoryRuleRequest {
  string match_pattern = 1 [(buf.validate.field).string = { min_len: 1 max_len: 255 }];
  string clean_name = 2 [(buf.validate.field).string = { max_len: 255 }];
  optional string category_id = 3 [(buf.validate.field).string = { uuid: true }];
  bool is_recurring = 4;
  bool apply_to_existing = 5; // Apply to existing matching transactions
}

message CreateCategoryRuleResponse {
  CategoryRule rule = 1;
  int64 transactions_updated = 2; // Number of existing transactions updated
}

message ListCategoryRulesRequest {}

message ListCategoryRulesResponse {
  repeated CategoryRule rules = 1 [(buf.validate.field).repeated = { max_items: 1000 }];
}

// Quick Capture: Manual transaction entry from natural language
message CreateManualTransactionRequest {
  // Natural language input, e.g. "Coffee 1$" or "Dinner €25"
  string raw_text = 1 [(buf.validate.field).string = { min_len: 1 max_len: 512 }];
  
  // Optional overrides for parsed values
  optional int64 amount_minor = 2 [(buf.validate.field).int64 = { gte: -900000000000000 lte: 900000000000000 }];
  optional string category_id = 3 [(buf.validate.field).string = { uuid: true }];
  optional string description = 4 [(buf.validate.field).string = { max_len: 512 }];
  optional google.protobuf.Timestamp date = 5;
  optional string account_id = 6 [(buf.validate.field).string = { uuid: true }];
}

message CreateManualTransactionResponse {
  Transaction transaction = 1 [(buf.validate.field).required = true];
  
  // Parsed interpretation feedback
  string parsed_description = 2;
  int64 parsed_amount_minor = 3;
  optional string suggested_category_id = 4;
  
  // Budget impact feedback: "This puts you at 95% of your Fun budget"
  optional string budget_impact = 5;
}
